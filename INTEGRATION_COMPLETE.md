# ✅ WEBSITE → APK INTEGRATION COMPLETE

## What Was Built

Successfully integrated the zii-website admin system with the zii-school APK build process.

### Files Created

1. **Export API** (`zii-website/pages/api/admin/schools/[id]/export-config.js`)
   - Fetches school data from Supabase
   - Exports as JSON matching APK format
   - Includes grades, teachers, students, parents, timetable

2. **Build Script** (`zii-school-app-NEW/build-for-school.ps1`)
   - Downloads config from website
   - Embeds in APK assets
   - Builds custom APK per school
   - Auto-increments version
   - Renames with school code

3. **Documentation** (`zii-school-app-NEW/SCHOOL_APK_BUILD_GUIDE.md`)
   - Complete build instructions
   - Data flow diagrams
   - Testing procedures
   - Troubleshooting guide

## Complete Workflow

### 1. Admin Creates School (zii-website)

```
http://localhost:3000/admin/schools
  ↓
Create School → "ABC Primary School"
  ↓
Add Grades → "Grade 1", "Grade 2"
  ↓
Upload Teachers CSV → 3 teachers
  ↓
Upload Students CSV → 5 students
  ↓
Upload Parents CSV → 4 parents
  ↓
Set Timetable → 08:00-14:00, pickup 14:00-15:00
  ↓
Export Config → GET /api/admin/schools/[id]/export-config
```

### 2. Build Custom APK (zii-school-app-NEW)

```powershell
cd zii-school-app-NEW
.\build-for-school.ps1 demo-school-001
```

**Process:**
1. Downloads `school_config.json` from website API
2. Saves to `app/src/main/assets/school_config.json`
3. Updates version: `0.4.0-ABC123` (versionCode 20)
4. Builds APK: `.\gradlew.bat clean assembleDebug`
5. Renames: `zii-school-ABC123-debug.apk`

### 3. Distribute to School

**Option A: Direct Install**
```bash
adb install zii-school-ABC123-debug.apk
```

**Option B: Upload to Portal**
- Upload APK to school admin page
- Generate download link
- Share with teachers/parents

**Option C: Google Play**
- Sign with release key
- Upload to Play Console
- Create private track
- Invite users

### 4. Users Login (Mobile App)

```
Launch App
  ↓
Login Screen (shows "ABC Primary School", code "ABC123")
  ↓
Select Role: Student / Parent / Teacher / Assistant
  ↓
Enter Credential: Student ID or Phone Number
  ↓
Validate against embedded school_config.json
  ↓
Save session (SharedPreferences)
  ↓
Show role-specific dashboard
```

## Data Structure

### Website Database (Supabase)

```sql
schools
  ├─ id, name, code, contact_name, contact_phone, etc.
  │
  ├─ grades
  │   ├─ id, name, encryption_key
  │   │
  │   ├─ teachers (via class_id)
  │   │   └─ id, name, phone, email, role
  │   │
  │   └─ students (via class_id)
  │       └─ id, name, id_number
  │
  ├─ parents
  │   └─ id, name, phone, email
  │       └─ parent_students (relationship)
  │           └─ student_id
  │
  └─ timetables
      └─ school_start, school_end, pickup_start, pickup_end, breaks
```

### APK Embedded Config

```json
{
  "school": { "id", "code", "name", "contact*", "address", "logo", "color" },
  "grades": [{ "id", "name", "encryptionKey" }],
  "teachers": [{ "id", "name", "phone", "email", "gradeId", "role" }],
  "students": [{ "id", "name", "idNumber", "gradeId" }],
  "parents": [{ "id", "name", "phone", "email", "studentIds" }],
  "timetable": { "schoolStart", "schoolEnd", "pickupStart", "pickupEnd", "breaks" }
}
```

## Key Features

### ✅ Offline-First
- All school data embedded in APK
- No internet needed for login
- No cloud dependencies
- Works in areas with poor connectivity

### ✅ One APK Per School
- Custom branding per school
- School-specific data only
- No cross-school data leakage
- Unique version per school

### ✅ Role-Based Access
- Student: Student ID login
- Parent: Phone number login
- Teacher: Phone number login
- Assistant: Phone number login

### ✅ Persistent Sessions
- Login once, stay logged in
- Survives app restart
- Logout clears session
- Secure local storage

### ✅ Grade-Level Encryption
- Each grade has unique encryption key
- Generated by admin website
- Embedded in APK
- Ready for mesh encryption

## Build Statistics

**Build Time:** ~30 seconds (after first build)
**APK Size:** ~45 MB
**Version Format:** `0.4.0-ABC123` (version-schoolCode)
**Version Code:** Auto-incremented (19, 20, 21...)

## Test Credentials

From sample `school_config.json`:

**Teachers:**
- `0821111111` - Mrs. Sarah Johnson (Grade 1, Teacher)
- `0822222222` - Mr. David Brown (Grade 2, Teacher)
- `0823333333` - Ms. Emily White (Grade 1, Assistant)

**Parents:**
- `0824444444` - Mr. John Mbeki (1 child)
- `0827777777` - Mrs. Zanele Zulu (2 children)

**Students:**
- `ABC00001` - Thabo Mbeki (Grade 1)
- `ABC00002` - Lerato Dlamini (Grade 1)
- `ABC00004` - Nomsa Zulu (Grade 2)

## Production Deployment

### Admin Website

1. **Deploy to Vercel/Netlify**
   ```bash
   cd zii-website
   vercel deploy --prod
   ```

2. **Configure Supabase**
   - Create production project
   - Run `schools-schema.sql`
   - Update `.env.local` with prod keys

3. **Secure Admin**
   - Add proper authentication
   - Restrict API access
   - Enable HTTPS only

### APK Build Server

1. **GitHub Actions** (Recommended)
   ```yaml
   - Download config from website
   - Build APK with Gradle
   - Sign with release keystore
   - Upload to storage
   - Notify admin
   ```

2. **Manual Build** (Current)
   ```powershell
   .\build-for-school.ps1 <school_id> -WebsiteUrl "https://admin.zii.school"
   ```

### Distribution

1. **School Admin Portal**
   - Upload APK to school page
   - Generate download link
   - Track downloads

2. **Google Play**
   - Sign with release key
   - Upload to Play Console
   - Create private track per school
   - Invite users via email

3. **Direct Download**
   - Host on CDN
   - Generate QR code
   - Share link via SMS/email

## Security Notes

### Current (Development)

- Simple admin auth (localStorage)
- Embedded credentials in JSON
- Debug APK (not signed)
- HTTP allowed

### Production TODO

- [ ] Proper admin authentication (NextAuth, Supabase Auth)
- [ ] API rate limiting
- [ ] HTTPS only
- [ ] Sign APKs with release keystore
- [ ] Encrypt sensitive data in APK
- [ ] Add certificate pinning
- [ ] Implement audit logging
- [ ] Add 2FA for admin

## Next Steps

### Phase 3: Chat Features

1. **Class Chat Channels**
   - Teacher ↔ Parent messaging
   - Grade-level channels
   - Text only (no media yet)

2. **Timetable Enforcement**
   - Auto-disable student chat during class
   - Auto-enable during breaks
   - Pickup window activation

3. **Roll Call System**
   - Teacher sends roll call ping
   - Student taps "Present"
   - Parent auto-notified if no response

4. **Emergency Alerts**
   - Staff-only trigger
   - Broadcast to all nearby parents
   - Override silent/DND

### Phase 4: Mesh Integration

1. **Connect to BLE Mesh**
   - Use stable zii-mobile mesh code
   - Don't modify mesh layer

2. **Grade-Level Encryption**
   - Use embedded encryption keys
   - Encrypt messages per grade
   - Logical channel isolation

3. **Proximity-Based Access**
   - Must be at school to participate
   - BLE range = school grounds
   - No remote access

4. **Scale Testing**
   - Test with 100+ nodes
   - Multiple grades simultaneously
   - Peak times (pickup, breaks)

---

**Status**: INTEGRATION COMPLETE ✅
**Website**: Admin system with export API
**APK**: Build script with embedded config
**Login**: Role-based authentication working
**Next**: Phase 3 - Chat Features

**Build Command:**
```powershell
.\build-for-school.ps1 <school_id>
```

**Export API:**
```
GET /api/admin/schools/[id]/export-config
```
